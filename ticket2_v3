from dataclasses import dataclass
from typing import Protocol


class MaleniaState(Protocol):
    def name(self) -> str:
        ...

    def attack(self, boss: "MaleniaBoss") -> str:
        ...


class BladeOfMiquellaState:
    def name(self) -> str:
        return "BladeOfMiquella"

    def attack(self, boss: "MaleniaBoss") -> str:
        return "Quick Slash"


class GoddessOfRotState:
    def name(self) -> str:
        return "GoddessOfRot"

    def attack(self, boss: "MaleniaBoss") -> str:
        return "Scarlet Aeonia"


class DamageError(ValueError):
    pass


def _state_for_phase(phase: int) -> MaleniaState:
    if phase == 1:
        return BladeOfMiquellaState()
    return GoddessOfRotState()


@dataclass
class MaleniaBoss:
    max_hp: int
    phase: int
    hp: int
    _state: MaleniaState
    is_defeated: bool = False
    last_transition_message: str = ""

    @classmethod
    def create(cls, max_hp: int = 100) -> "MaleniaBoss":
        return cls(
            max_hp=max_hp,
            phase=1,
            hp=max_hp,
            _state=_state_for_phase(1),
            is_defeated=False,
            last_transition_message="",
        )

    def phase_name(self) -> str:
        return self._state.name()

    def attack(self) -> str:
        return self._state.attack(self)

    def phase_max_hp(self) -> int:
        if self.phase == 1:
            return self.max_hp
        return int(self.max_hp * 0.80)

    def take_damage(self, amount: int) -> None:
        if amount <= 0:
            raise DamageError("damage amount must be > 0")
        if self.is_defeated:
            return

        self.last_transition_message = ""

        self.hp -= amount
        if self.hp > 0:
            return

        if self.phase == 1:
            self.phase = 2
            self._state = _state_for_phase(2)
            self.hp = self.phase_max_hp()
            self.last_transition_message = "Phase 2 begins: Goddess of Rot (HP restored to 80%)"
            return

        self.hp = 0
        self.is_defeated = True
        self.last_transition_message = "Malenia defeated"

    def on_successful_hit(self) -> None:
        """
        Malenia heals 1% of max_hp on each successful hit.
        FIX: capped to phase_max_hp() (100% in phase 1, 80% in phase 2).
        """
        if self.is_defeated:
            return

        heal = max(1, int(self.max_hp * 0.01))
        self.hp += heal

        limit = self.phase_max_hp()
        if self.hp > limit:
            self.hp = limit


def main() -> int:
    boss = MaleniaBoss.create(max_hp=100)
    print("START:", boss.phase, boss.phase_name(), "HP=", boss.hp, "attack=", boss.attack())

    boss.take_damage(110)
    if boss.last_transition_message:
        print("[TRANSITION]", boss.last_transition_message)
    print("AFTER P1:", boss.phase, boss.phase_name(), "HP=", boss.hp, "attack=", boss.attack())

    boss.on_successful_hit()
    print("HIT HEAL:", boss.phase, boss.phase_name(), "HP=", boss.hp)

    boss.take_damage(90)
    if boss.last_transition_message:
        print("[TRANSITION]", boss.last_transition_message)
    print("AFTER P2:", boss.phase, boss.phase_name(), "HP=", boss.hp, "defeated=", boss.is_defeated)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
